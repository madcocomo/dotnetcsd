# 超市收银机练习

你需要实现一个超市自助收银机的应用。

起始工程中以及包括一些代码和API，这些都是用来作为示例的，你可以把它们移除。\
除了**数据库表结构，API定义，properties 文件中已经定义的属性**，其它的代码都可以进行修改。

采用极限编程实践进行编码，包括TDD，重构，结对编程或MOB等。
当你完成时，把代码push到小组分支（无需提交PR），并与PO确认是否完成了需求。

可以预见到超市将会有促销业务，所以收银模块也应该支持。不过目前还不需要马上支持。

## 基本功能
你需要实现API `/api/cart/items` \
这个API应该接受`POST`请求，条码信息以JSON数组形式传入。
```json
[
  {"barcode": "12345678" },
  {"barcode": "22345678", "quantity": 3 }
]
```
数组中的每一行代表一个条码。\
如 `12345678` 行是一个标准条码的商品, \
如 `22345678` 行表示三个 条码为 `22345678` 的商品。

API应该返回一个JSON对象。

```json
{
    "items": [
        { "name": "pizza", "quantity": "1", "price": 15.0, "sum": 15.0 },
        { "name": "milk", "quantity": "3L",  "price": 12.3, "sum": 36.90 }
    ],
    "total": 51.90
}
```

## 校验和汇总

你需要对API `/api/cart/items` 进行功能增强并增加校验。

如果传入的条码在数据库中不存在，应该返回错误信息。
```
    item doesn't exist: 88888888
```

对于重复扫码的商品，收据中应该进行汇总。比如，
```json
[
  {"barcode": "12345678" },
  {"barcode": "12345678" },
  {"barcode": "12345678" }
]
```

应该返回的结果是：
```json
{
    "items": [
    { "name": "pizza", "quantity": "3", "price": 15.0, "sum": 45.0 }
    ],
    "total": 45.0
}
```

## 保存订单、打印收据
当用户选择支付时，会以 `POST` 请求API `/api/cart`，请求体格式同上。
服务接受请求后，应该
1. 调用订单服务 `POST` `http://order.svc/api/orders` 请求体
```json
{
 "items": [
  { "barcode": "12345678", "quantity": 1, "sum": 15.0 },
  { "barcode": "22345678", "quantity": 3, "sum": 36.90 }
 ],
 "total": 51.90
}
```
如果成功，订单服务返回订单号
```json
{
 "orderId": "ORD01014893"
}
```

2. 调用支付服务`POST` `http://payment.svc/api/payments` 请求体
```json
{
 "orderId": "ORD01014893",
 "amount": 51.90
}
```
如果成功，支付服务返回支付流水号
```json
{
 "txnId": "TXN3457832001"
}
```

3. 更新订单状态 `POST` `http://order.svc/api/orders/ORD01014893/payment/TXN3457832001` 请求体为空
如果成功，订单服务返回订单号
```json
{
 "orderId": "ORD01014893"
}
```
4. 调用收据小票打印服务 `POST` `http://printer.svc/api/recepts` 请求体
```json
{
 "data": [
   "******* SuperMarket receipt *******",
   "                        ORD01014893",
   "pizza  4 x 15.00 ------------ 45.00",
   "milk  3(L) x 12.30 ---------- 36.90",
   "-----------------------------------",
   "                  total: 81.90(CNY)",
   "***********************************"
 ]
}
```
data中的内容是待打印的小票内容，宽度为每行35个字符，汉字以2个字符宽度打印。\
当商品名称过长时应进行字符串截断。

### 参考信息
超市中的商品保存在 `item` 表中，以下是示例字段（部分字段省略）

| barcode  | name  | unit | price | type |
|----------|-------|------|-------|------|
| 12345678 | pizza |      | 15    | 0    |
| 22345678 | milk  | L    | 12.3  | 1    |

促销信息保存在 `promotion` 表中，以下是示例字段（部分字段省略）

| id   | name        | type |
|------|-------------|------|
| P001 | just buy it | 0    |
| P002 | hot sale    | 1    |

`item` 与 `promotion` 之间是多对多关系。两者的关联信息保存在 `promotion_item` 表中。

| promotion_id | item_barcode |
|--------------|--------------|
| P001         | 12345678     |
| P002         | 22345678     |

